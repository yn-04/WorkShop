@inject WorkShop.Service.Interfaces.IMenuService MenuService

@{
    TempData.Keep();
    string? currentPage = ViewContext.HttpContext.Request.Path;

    // เรียก Service เพื่อดึงเมนู (ควรมีการกรอง IsActive ใน Service แล้ว)
    var allowedMenus = await MenuService.GetAllowedMenusAsync(User);
}

<aside id="layout-menu" class="layout-menu menu-vertical menu bg-menu-theme">

    @* Logo *@
    @* แก้ไข: class'app-brand เป็น class="app-brand" และปรับลด @ ที่ซ้ำซ้อน *@
    <div class="app-brand demo @(ViewData["navbarFull"] != null && Convert.ToBoolean(ViewData["navbarFull"]) ? "d-xl-none" : "")">
        <a asp-controller="Home" asp-action="Index" class="app-brand-link gap-xl-0 gap-2">
            <span class="app-brand-logo demo me-1">
                @* ตรวจสอบ Path รูปภาพให้ถูกต้อง *@
                <img src="~/img/WS_logo.png" width="30" alt="Logo" />
            </span>
            <span class="app-brand-text demo menu-text fw-semibold ms-2">@TempData.Peek("appName")</span>
        </a>
    </div>

    <div class="menu-inner-shadow"></div>

    @* Dynamic Menu *@
    <ul class="menu-inner py-1">
        @if (allowedMenus != null)
        {
            foreach (var menu in allowedMenus)
            {
                // ตรวจสอบว่า URL ปัจจุบันตรงกับเมนูนี้หรือไม่ (ใช้ StringComparison เพื่อความแม่นยำ)
                // ถ้า ControllerName เป็นค่าว่างหรือ Null จะข้ามไป
                if (string.IsNullOrEmpty(menu.ControllerName)) continue;

                bool isActive = currentPage != null && 
                                currentPage.StartsWith($"/{menu.ControllerName}", StringComparison.OrdinalIgnoreCase);

                <li class="menu-item @(isActive ? "active" : "")">
                    <a asp-controller="@menu.ControllerName" asp-action="@menu.ActionName" class="menu-link">
                        @* ตรวจสอบว่ามี IconClass หรือไม่ ถ้าไม่มีใส่ค่า Default *@
                        <i class="menu-icon tf-icons @(!string.IsNullOrEmpty(menu.IconClass) ? menu.IconClass : "ri-checkbox-blank-circle-line")"></i>
                        <div>@menu.MenuName</div>
                    </a>
                </li>
            }
        }

        @* ปุ่ม Logout *@
        <li class="menu-item">
            <a asp-controller="User" asp-action="Logout" class="menu-link">
                <i class="menu-icon icon-base ri ri-logout-box-r-line"></i>
                <div>Logout</div>
            </a>
        </li>
    </ul>
</aside>